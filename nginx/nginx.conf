# Run as www-data user (more secure than root)
user www-data;

# Auto-detect number of CPU cores
worker_processes auto;

# PID file location
pid /run/nginx.pid;

# Number of file descriptors per worker
worker_rlimit_nofile 65535;

# Load dynamic modules
include /etc/nginx/modules-enabled/*.conf;

events {
    # Max connections per worker
    worker_connections 4096;

    # Optimize for Linux
    use epoll;

    # Accept multiple connections at once
    multi_accept on;
}

http {

    # =====================================
    # Basic Settings
    # =====================================
    
    # Hide nginx version
    server_tokens off;
    
    # Optimize sendfile for static files
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # Keep-alive settings
    keepalive_timeout 65;
    keepalive_requests 100;
    
    # Hash tables optimization
    types_hash_max_size 2048;
    server_names_hash_bucket_size 128;
    server_names_hash_max_size 1024;
    
    # MIME types
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # =====================================
    # Gzip Compression
    # =====================================

    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    
    # =====================================
    # Proxy Settings
    # =====================================
    
    # Proxy cache path (optional, for caching static content)
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=cache:10m 
                     max_size=1g inactive=60m use_temp_path=off;
    
    # WebSocket upgrade map
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
    
    # =====================================
    # Includes
    # =====================================
    
    # Additional configurations
    include /etc/nginx/conf.d/*.conf;
    
    # Virtual hosts
	include /etc/nginx/sites-enabled/*;

}
